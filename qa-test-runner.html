<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TODO-LIST QA 테스트 러너</title>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .test-header {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }

    .test-section {
      margin-bottom: 30px;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
    }

    .test-section h3 {
      margin-top: 0;
      color: #2196F3;
    }

    .test-case {
      margin: 10px 0;
      padding: 10px;
      border-left: 3px solid #ccc;
      background-color: #fafafa;
    }

    .test-case.pass {
      border-left-color: #4CAF50;
      background-color: #f1f8e9;
    }

    .test-case.fail {
      border-left-color: #f44336;
      background-color: #ffebee;
    }

    .test-case.running {
      border-left-color: #ff9800;
      background-color: #fff3e0;
    }

    .test-controls {
      text-align: center;
      margin-bottom: 20px;
    }

    .test-controls button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .test-controls button:hover {
      background: #1976D2;
    }

    .test-controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .browser-info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .test-log {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }

    .iframe-container {
      border: 1px solid #ddd;
      border-radius: 5px;
      height: 400px;
      margin: 20px 0;
    }

    .iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
</head>

<body>
  <div class="test-container">
    <h1 class="test-header">TODO-LIST 모바일 환경 QA 테스트</h1>

    <div class="browser-info">
      <h3>브라우저 정보</h3>
      <div id="browser-info"></div>
    </div>

    <div class="test-controls">
      <button onclick="runAllTests()">전체 테스트 실행</button>
      <button onclick="runSingleTest()">단일 테스트 실행</button>
      <button onclick="clearResults()">결과 초기화</button>
      <button onclick="downloadReport()">결과 다운로드</button>
    </div>

    <div class="test-section">
      <h3>인증 가드 테스트 (AuthGuard System)</h3>
      <div id="auth-guard-tests"></div>
    </div>

    <div class="test-section">
      <h3>모바일 호환성 테스트</h3>
      <div id="mobile-compat-tests"></div>
    </div>

    <div class="test-section">
      <h3>성능 테스트</h3>
      <div id="performance-tests"></div>
    </div>

    <div class="test-section">
      <h3>PWA 기능 테스트</h3>
      <div id="pwa-tests"></div>
    </div>

    <div class="test-section">
      <h3>테스트 앱 미리보기</h3>
      <div class="iframe-container">
        <iframe id="test-iframe" src="http://localhost:8000" title="TODO-LIST 애플리케이션 테스트 환경"></iframe>
      </div>
    </div>

    <div class="test-section">
      <h3>테스트 로그</h3>
      <div id="test-log" class="test-log"></div>
    </div>
  </div>

  <script>
    // 전역 테스트 상태
    const testState = {
      isRunning: false,
      results: [],
      startTime: null,
      logs: []
    };

    // 로그 함수
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `[${timestamp}] ${message}`;
      testState.logs.push(logMessage);

      const logElement = document.getElementById('test-log');
      logElement.textContent += logMessage + '\n';
      logElement.scrollTop = logElement.scrollHeight;

      console.log(logMessage);
    }

    // 브라우저 정보 수집
    function collectBrowserInfo() {
      const info = {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        cookieEnabled: navigator.cookieEnabled,
        onLine: navigator.onLine,
        viewport: {
          width: window.innerWidth,
          height: window.innerHeight
        },
        screen: {
          width: screen.width,
          height: screen.height,
          devicePixelRatio: window.devicePixelRatio
        }
      };

      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const browserType = detectBrowserType();

      document.getElementById('browser-info').innerHTML = `
                <div><strong>브라우저:</strong> ${browserType}</div>
                <div><strong>모바일:</strong> ${isMobile ? 'Yes' : 'No'}</div>
                <div><strong>화면 크기:</strong> ${info.viewport.width} x ${info.viewport.height}</div>
                <div><strong>디바이스 픽셀 비율:</strong> ${info.screen.devicePixelRatio}</div>
                <div><strong>온라인 상태:</strong> ${info.onLine ? 'Online' : 'Offline'}</div>
            `;

      return { ...info, isMobile, browserType };
    }

    // 브라우저 타입 감지
    function detectBrowserType() {
      const ua = navigator.userAgent;

      if (ua.includes('Chrome') && !ua.includes('Edge')) {
        if (ua.includes('Mobile')) return 'Chrome Mobile';
        return 'Chrome Desktop';
      } else if (ua.includes('Safari') && !ua.includes('Chrome')) {
        if (ua.includes('Mobile')) return 'Safari Mobile';
        return 'Safari Desktop';
      } else if (ua.includes('Samsung')) {
        return 'Samsung Internet';
      } else if (ua.includes('wv') && ua.includes('Chrome')) {
        return 'Android WebView';
      } else if (ua.includes('Firefox')) {
        return 'Firefox';
      } else if (ua.includes('Edge')) {
        return 'Microsoft Edge';
      }

      return 'Unknown';
    }

    // 테스트 케이스 정의
    const testCases = {
      authGuard: [
        {
          id: 'tc-001',
          name: '초기 로딩 상태 확인',
          description: '페이지 로딩 시 AuthGuard 로딩 상태 표시',
          test: testInitialLoadingState
        },
        {
          id: 'tc-002',
          name: '비인증 상태 TODO 리스트 차단',
          description: '로그인하지 않은 상태에서 TODO 기능 접근 차단',
          test: testUnauthenticatedAccess
        },
        {
          id: 'tc-003',
          name: '인증 플로우 테스트',
          description: '로그인 폼 및 인증 관련 UI 테스트',
          test: testAuthenticationFlow
        }
      ],
      mobileCompat: [
        {
          id: 'tc-004',
          name: '터치 인터페이스 호환성',
          description: '모바일 터치 이벤트 정상 동작',
          test: testTouchInterface
        },
        {
          id: 'tc-005',
          name: '화면 회전 대응',
          description: '세로/가로 모드 전환 시 레이아웃 유지',
          test: testOrientationChange
        },
        {
          id: 'tc-006',
          name: '반응형 디자인',
          description: '다양한 화면 크기에서 레이아웃 적응',
          test: testResponsiveDesign
        }
      ],
      performance: [
        {
          id: 'tc-007',
          name: '초기 로딩 성능',
          description: '페이지 로드 성능 측정',
          test: testInitialLoadingPerformance
        },
        {
          id: 'tc-008',
          name: '메모리 사용량',
          description: '메모리 효율성 및 누수 확인',
          test: testMemoryUsage
        }
      ],
      pwa: [
        {
          id: 'tc-009',
          name: 'PWA 매니페스트',
          description: 'PWA 매니페스트 파일 유효성',
          test: testPWAManifest
        },
        {
          id: 'tc-010',
          name: 'Service Worker',
          description: 'Service Worker 등록 및 동작',
          test: testServiceWorker
        }
      ]
    };

    // 테스트 케이스 실행 함수들
    async function testInitialLoadingState() {
      return new Promise((resolve) => {
        const iframe = document.getElementById('test-iframe');
        const checkLoading = () => {
          try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const loadingOverlay = iframeDoc.getElementById('auth-guard-loading') ||
              iframeDoc.getElementById('auth-loading-overlay');

            if (loadingOverlay) {
              resolve({
                success: true,
                message: '로딩 오버레이 정상 표시',
                details: {
                  loadingOverlayFound: true,
                  isVisible: getComputedStyle(loadingOverlay).display !== 'none'
                }
              });
            } else {
              setTimeout(checkLoading, 100);
            }
          } catch (e) {
            resolve({
              success: false,
              message: 'iframe 접근 제한으로 인한 테스트 제한',
              error: e.message
            });
          }
        };

        // iframe 새로고침
        iframe.src = iframe.src;
        setTimeout(checkLoading, 1000);
      });
    }

    async function testUnauthenticatedAccess() {
      return new Promise((resolve) => {
        setTimeout(() => {
          try {
            const iframe = document.getElementById('test-iframe');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

            const authSection = iframeDoc.getElementById('auth-section');
            const todoApp = iframeDoc.getElementById('todo-app');

            const authVisible = authSection && getComputedStyle(authSection).display !== 'none';
            const todoHidden = todoApp && (
              todoApp.classList.contains('todo-app-hidden') ||
              getComputedStyle(todoApp).display === 'none'
            );

            resolve({
              success: authVisible && todoHidden,
              message: authVisible && todoHidden ?
                '인증 섹션 표시, TODO 앱 숨김 정상' :
                '인증 가드 동작 이상',
              details: {
                authSectionVisible: authVisible,
                todoAppHidden: todoHidden
              }
            });
          } catch (e) {
            resolve({
              success: false,
              message: 'iframe 접근 제한',
              error: e.message
            });
          }
        }, 3000);
      });
    }

    async function testAuthenticationFlow() {
      return new Promise((resolve) => {
        try {
          const iframe = document.getElementById('test-iframe');
          const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

          const loginForm = iframeDoc.getElementById('login-form');
          const emailInput = iframeDoc.getElementById('login-email');
          const passwordInput = iframeDoc.getElementById('login-password');
          const googleLogin = iframeDoc.getElementById('google-login');

          const formExists = !!loginForm;
          const inputsAccessible = !!(emailInput && passwordInput);
          const googleButtonExists = !!googleLogin;

          resolve({
            success: formExists && inputsAccessible && googleButtonExists,
            message: '로그인 폼 구성 요소 확인',
            details: {
              loginFormExists: formExists,
              inputFieldsAccessible: inputsAccessible,
              googleButtonExists: googleButtonExists
            }
          });
        } catch (e) {
          resolve({
            success: false,
            message: 'iframe 접근 제한',
            error: e.message
          });
        }
      });
    }

    async function testTouchInterface() {
      const browserInfo = collectBrowserInfo();

      if (!browserInfo.isMobile) {
        return {
          success: true,
          message: '데스크톱 환경에서는 터치 테스트 건너뜀',
          skipped: true
        };
      }

      return {
        success: 'ontouchstart' in window,
        message: 'ontouchstart' in window ?
          '터치 이벤트 지원됨' :
          '터치 이벤트 미지원',
        details: {
          touchEventsSupported: 'ontouchstart' in window,
          touchScreenDetected: navigator.maxTouchPoints > 0
        }
      };
    }

    async function testOrientationChange() {
      return {
        success: 'onorientationchange' in window,
        message: 'onorientationchange' in window ?
          '화면 회전 이벤트 지원됨' :
          '화면 회전 이벤트 미지원',
        details: {
          orientationChangeSupported: 'onorientationchange' in window,
          currentOrientation: screen.orientation ? screen.orientation.angle : 'unknown'
        }
      };
    }

    async function testResponsiveDesign() {
      const viewport = {
        width: window.innerWidth,
        height: window.innerHeight
      };

      const isMobileSize = viewport.width < 768;
      const isTabletSize = viewport.width >= 768 && viewport.width < 1024;
      const isDesktopSize = viewport.width >= 1024;

      return {
        success: true,
        message: `${isMobileSize ? '모바일' : isTabletSize ? '태블릿' : '데스크톱'} 크기 감지`,
        details: {
          viewport,
          deviceCategory: isMobileSize ? 'mobile' : isTabletSize ? 'tablet' : 'desktop',
          isMobileSize,
          isTabletSize,
          isDesktopSize
        }
      };
    }

    async function testInitialLoadingPerformance() {
      if (!('performance' in window)) {
        return {
          success: false,
          message: 'Performance API 미지원'
        };
      }

      const navigation = performance.getEntriesByType('navigation')[0];
      const loadTime = navigation ? navigation.loadEventEnd - navigation.fetchStart : 0;

      const paintTimings = performance.getEntriesByType('paint');
      const fcp = paintTimings.find(p => p.name === 'first-contentful-paint');

      return {
        success: loadTime < 3000,
        message: `페이지 로드 시간: ${loadTime.toFixed(0)}ms`,
        details: {
          totalLoadTime: loadTime,
          firstContentfulPaint: fcp ? fcp.startTime : 0,
          isPerformant: loadTime < 3000
        }
      };
    }

    async function testMemoryUsage() {
      if (!('memory' in performance)) {
        return {
          success: true,
          message: 'Memory API 미지원 (Chrome 전용)',
          skipped: true
        };
      }

      const memory = performance.memory;
      const usedMB = (memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
      const limitMB = (memory.jsHeapSizeLimit / 1024 / 1024).toFixed(1);

      return {
        success: memory.usedJSHeapSize < memory.jsHeapSizeLimit * 0.8,
        message: `메모리 사용량: ${usedMB}MB / ${limitMB}MB`,
        details: {
          usedJSHeapSize: memory.usedJSHeapSize,
          totalJSHeapSize: memory.totalJSHeapSize,
          jsHeapSizeLimit: memory.jsHeapSizeLimit,
          usagePercentage: (memory.usedJSHeapSize / memory.jsHeapSizeLimit * 100).toFixed(1)
        }
      };
    }

    async function testPWAManifest() {
      try {
        const response = await fetch('/manifest.json');
        const manifest = await response.json();

        const requiredFields = ['name', 'short_name', 'start_url', 'display', 'icons'];
        const hasRequiredFields = requiredFields.every(field => manifest[field]);

        return {
          success: hasRequiredFields,
          message: hasRequiredFields ?
            'PWA 매니페스트 유효함' :
            '필수 필드 누락',
          details: {
            manifest,
            hasRequiredFields,
            missingFields: requiredFields.filter(field => !manifest[field])
          }
        };
      } catch (e) {
        return {
          success: false,
          message: 'PWA 매니페스트 로드 실패',
          error: e.message
        };
      }
    }

    async function testServiceWorker() {
      if (!('serviceWorker' in navigator)) {
        return {
          success: false,
          message: 'Service Worker 미지원'
        };
      }

      try {
        const registration = await navigator.serviceWorker.getRegistration('/sw.js');

        return {
          success: !!registration,
          message: registration ?
            'Service Worker 등록됨' :
            'Service Worker 미등록',
          details: {
            isRegistered: !!registration,
            scope: registration ? registration.scope : null,
            state: registration && registration.active ? registration.active.state : null
          }
        };
      } catch (e) {
        return {
          success: false,
          message: 'Service Worker 확인 실패',
          error: e.message
        };
      }
    }

    // 테스트 실행 함수들
    async function runAllTests() {
      if (testState.isRunning) {
        log('이미 테스트가 실행 중입니다');
        return;
      }

      testState.isRunning = true;
      testState.startTime = Date.now();
      testState.results = [];

      log('전체 테스트 시작');

      // 모든 테스트 카테고리 실행
      for (const [category, tests] of Object.entries(testCases)) {
        log(`${category} 테스트 카테고리 시작`);

        for (const test of tests) {
          await runSingleTestCase(test, category);
        }
      }

      const duration = Date.now() - testState.startTime;
      const totalTests = testState.results.length;
      const passedTests = testState.results.filter(r => r.success).length;

      log(`테스트 완료: ${passedTests}/${totalTests} 통과 (${duration}ms)`);

      testState.isRunning = false;
      updateTestResultsDisplay();
    }

    async function runSingleTestCase(testCase, category) {
      log(`${testCase.id}: ${testCase.name} 실행`);

      updateTestCaseStatus(testCase.id, 'running');

      try {
        const result = await testCase.test();

        const testResult = {
          id: testCase.id,
          name: testCase.name,
          category,
          success: result.success,
          message: result.message,
          details: result.details,
          error: result.error,
          skipped: result.skipped,
          timestamp: new Date().toISOString()
        };

        testState.results.push(testResult);

        updateTestCaseStatus(testCase.id, result.success ? 'pass' : 'fail', result.message);

        log(`${testCase.id}: ${result.success ? '통과' : '실패'} - ${result.message}`);

      } catch (error) {
        const testResult = {
          id: testCase.id,
          name: testCase.name,
          category,
          success: false,
          message: '테스트 실행 중 오류',
          error: error.message,
          timestamp: new Date().toISOString()
        };

        testState.results.push(testResult);

        updateTestCaseStatus(testCase.id, 'fail', error.message);

        log(`${testCase.id}: 오류 - ${error.message}`);
      }
    }

    function updateTestCaseStatus(testId, status, message = '') {
      const element = document.getElementById(testId);
      if (element) {
        element.className = `test-case ${status}`;
        if (message) {
          const messageElement = element.querySelector('.test-message');
          if (messageElement) {
            messageElement.textContent = message;
          }
        }
      }
    }

    function updateTestResultsDisplay() {
      // 테스트 케이스별 결과 표시 업데이트
      Object.entries(testCases).forEach(([category, tests]) => {
        const container = document.getElementById(`${category.replace(/([A-Z])/g, '-$1').toLowerCase()}-tests`);
        if (container) {
          container.innerHTML = tests.map(test => {
            const result = testState.results.find(r => r.id === test.id);
            const status = result ? (result.success ? 'pass' : 'fail') : '';
            const message = result ? result.message : '';

            return `
                            <div id="${test.id}" class="test-case ${status}">
                                <strong>${test.id.toUpperCase()}: ${test.name}</strong>
                                <div>${test.description}</div>
                                <div class="test-message">${message}</div>
                            </div>
                        `;
          }).join('');
        }
      });
    }

    function clearResults() {
      testState.results = [];
      testState.logs = [];
      document.getElementById('test-log').textContent = '';

      // 모든 테스트 케이스 상태 초기화
      Object.entries(testCases).forEach(([category, tests]) => {
        tests.forEach(test => {
          updateTestCaseStatus(test.id, '');
        });
      });

      log('테스트 결과 초기화됨');
    }

    function downloadReport() {
      const report = {
        timestamp: new Date().toISOString(),
        browserInfo: collectBrowserInfo(),
        testResults: testState.results,
        logs: testState.logs,
        summary: {
          totalTests: testState.results.length,
          passedTests: testState.results.filter(r => r.success).length,
          failedTests: testState.results.filter(r => !r.success && !r.skipped).length,
          skippedTests: testState.results.filter(r => r.skipped).length
        }
      };

      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `qa-test-report-${report.browserInfo.browserType}-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      log('테스트 보고서 다운로드됨');
    }

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', () => {
      collectBrowserInfo();
      updateTestResultsDisplay();
      log('QA 테스트 러너 초기화 완료');
    });
  </script>
</body>

</html>