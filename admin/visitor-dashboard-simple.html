<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë°©ë¬¸ì í†µê³„ ëŒ€ì‹œë³´ë“œ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .dashboard {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5rem;
      color: #333;
      margin-bottom: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .stat-card h3 {
      font-size: 1.2rem;
      margin-bottom: 15px;
      opacity: 0.9;
    }

    .stat-number {
      font-size: 3rem;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .data-section {
      margin-bottom: 30px;
    }

    .data-section h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .data-table th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }

    .data-table tr:hover {
      background-color: #f8f9ff;
    }

    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }

    .refresh-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .refresh-btn:hover {
      opacity: 0.9;
    }

    .last-updated {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div class="dashboard">
    <div class="header">
      <h1>ğŸ” ë°©ë¬¸ì í†µê³„ ëŒ€ì‹œë³´ë“œ</h1>
      <button class="refresh-btn" onclick="loadDashboard()">ğŸ“Š ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>ì‹¤ì‹œê°„ ë°©ë¬¸ì</h3>
        <div class="stat-number" id="liveVisitors">-</div>
        <div>í˜„ì¬ ì ‘ì† ì¤‘</div>
      </div>
      <div class="stat-card">
        <h3>ì˜¤ëŠ˜ ë°©ë¬¸ì</h3>
        <div class="stat-number" id="todayVisitors">-</div>
        <div>ê³ ìœ  ë°©ë¬¸ì</div>
      </div>
      <div class="stat-card">
        <h3>ì˜¤ëŠ˜ ì´ ë°©ë¬¸</h3>
        <div class="stat-number" id="todayVisits">-</div>
        <div>í˜ì´ì§€ ë·°</div>
      </div>
      <div class="stat-card">
        <h3>ì´ ë°©ë¬¸ì</h3>
        <div class="stat-number" id="totalVisitors">-</div>
        <div>ëˆ„ì  ë°©ë¬¸ì</div>
      </div>
    </div>

    <div class="data-section">
      <h2>ğŸ“‹ ìµœê·¼ ë°©ë¬¸ì</h2>
      <div id="recentVisitors" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div class="data-section">
      <h2>ğŸŒ ìƒìœ„ IP ì£¼ì†Œ</h2>
      <div id="topIPs" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div class="last-updated" id="lastUpdated">
      ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -
    </div>
  </div>

  <script src="../scripts/api.js"></script>
  <script>
    // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
    async function loadDashboard() {
      console.log('ğŸ“Š ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹œì‘...');

      try {
        // ì‹¤ì‹œê°„ ë°©ë¬¸ì ìˆ˜
        await loadLiveVisitors();

        // ì˜¤ëŠ˜ í†µê³„
        await loadTodayStats();

        // ì´ ë°©ë¬¸ì ìˆ˜
        await loadTotalStats();

        // ìµœê·¼ ë°©ë¬¸ì
        await loadRecentVisitors();

        // ìƒìœ„ IP
        await loadTopIPs();

        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
        document.getElementById('lastUpdated').textContent =
          `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}`;

        console.log('âœ… ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì™„ë£Œ');

      } catch (error) {
        console.error('âŒ ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
        showError('ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    // ì‹¤ì‹œê°„ ë°©ë¬¸ì ìˆ˜ (ìµœê·¼ 5ë¶„)
    async function loadLiveVisitors() {
      try {
        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
        const { data, error } = await supabase
          .from('visitor_logs')
          .select('session_id')
          .gte('created_at', fiveMinutesAgo)
          .not('session_id', 'is', null);

        if (error) throw error;

        const uniqueSessions = new Set(data.map(row => row.session_id));
        document.getElementById('liveVisitors').textContent = uniqueSessions.size;

      } catch (error) {
        console.error('ì‹¤ì‹œê°„ ë°©ë¬¸ì ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('liveVisitors').textContent = '0';
      }
    }

    // ì˜¤ëŠ˜ í†µê³„
    async function loadTodayStats() {
      try {
        const today = new Date().toISOString().split('T')[0];
        const { data, error } = await supabase
          .from('visitor_logs')
          .select('session_id')
          .gte('created_at', today + 'T00:00:00.000Z')
          .lt('created_at', today + 'T23:59:59.999Z');

        if (error) throw error;

        const uniqueVisitors = new Set(data.map(row => row.session_id)).size;
        const totalVisits = data.length;

        document.getElementById('todayVisitors').textContent = uniqueVisitors;
        document.getElementById('todayVisits').textContent = totalVisits;

      } catch (error) {
        console.error('ì˜¤ëŠ˜ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('todayVisitors').textContent = '0';
        document.getElementById('todayVisits').textContent = '0';
      }
    }

    // ì´ ë°©ë¬¸ì ìˆ˜
    async function loadTotalStats() {
      try {
        const { data, error } = await supabase
          .from('visitor_logs')
          .select('session_id')
          .not('session_id', 'is', null);

        if (error) throw error;

        const totalUniqueVisitors = new Set(data.map(row => row.session_id)).size;
        document.getElementById('totalVisitors').textContent = totalUniqueVisitors;

      } catch (error) {
        console.error('ì´ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('totalVisitors').textContent = '0';
      }
    }

    // ìµœê·¼ ë°©ë¬¸ì
    async function loadRecentVisitors() {
      try {
        const { data, error } = await supabase
          .from('visitor_logs')
          .select('ip_address, device_type, browser, os, created_at, url')
          .order('created_at', { ascending: false })
          .limit(10);

        if (error) throw error;

        let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>IP ì£¼ì†Œ</th>
                                <th>ë””ë°”ì´ìŠ¤</th>
                                <th>ë¸Œë¼ìš°ì €</th>
                                <th>OS</th>
                                <th>ë°©ë¬¸ ì‹œê°„</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

        data.forEach(row => {
          html += `
                        <tr>
                            <td>${row.ip_address || 'Unknown'}</td>
                            <td>${row.device_type || '-'}</td>
                            <td>${row.browser || '-'}</td>
                            <td>${row.os || '-'}</td>
                            <td>${new Date(row.created_at).toLocaleString('ko-KR')}</td>
                        </tr>
                    `;
        });

        html += '</tbody></table>';
        document.getElementById('recentVisitors').innerHTML = html;

      } catch (error) {
        console.error('ìµœê·¼ ë°©ë¬¸ì ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('recentVisitors').innerHTML =
          '<div class="error">ìµœê·¼ ë°©ë¬¸ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
      }
    }

    // ìƒìœ„ IP ì£¼ì†Œ
    async function loadTopIPs() {
      try {
        const { data, error } = await supabase
          .from('visitor_logs')
          .select('ip_address, created_at, session_id')
          .not('ip_address', 'is', null)
          .order('created_at', { ascending: false })
          .limit(500); // ìµœê·¼ 500ê°œë§Œ ë¶„ì„

        if (error) throw error;

        // JavaScriptë¡œ IPë³„ í†µê³„ ê³„ì‚°
        const ipStats = {};
        data.forEach(row => {
          const ip = row.ip_address;
          if (!ipStats[ip]) {
            ipStats[ip] = {
              ip: ip,
              visits: 0,
              lastVisit: row.created_at,
              sessions: new Set()
            };
          }
          ipStats[ip].visits++;
          ipStats[ip].sessions.add(row.session_id);
          if (new Date(row.created_at) > new Date(ipStats[ip].lastVisit)) {
            ipStats[ip].lastVisit = row.created_at;
          }
        });

        // ìƒìœ„ 10ê°œ ì •ë ¬
        const topIPs = Object.values(ipStats)
          .map(stat => ({
            ...stat,
            uniqueSessions: stat.sessions.size
          }))
          .sort((a, b) => b.visits - a.visits)
          .slice(0, 10);

        let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>IP ì£¼ì†Œ</th>
                                <th>ë°©ë¬¸ íšŸìˆ˜</th>
                                <th>ê³ ìœ  ì„¸ì…˜</th>
                                <th>ë§ˆì§€ë§‰ ë°©ë¬¸</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

        topIPs.forEach(ip => {
          html += `
                        <tr>
                            <td>${ip.ip}</td>
                            <td>${ip.visits}</td>
                            <td>${ip.uniqueSessions}</td>
                            <td>${new Date(ip.lastVisit).toLocaleString('ko-KR')}</td>
                        </tr>
                    `;
        });

        html += '</tbody></table>';
        document.getElementById('topIPs').innerHTML = html;

      } catch (error) {
        console.error('ìƒìœ„ IP ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('topIPs').innerHTML =
          '<div class="error">ìƒìœ„ IP ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
      }
    }

    // ì—ëŸ¬ í‘œì‹œ
    function showError(message) {
      const errorDiv = `<div class="error">âŒ ${message}</div>`;
      document.querySelectorAll('.loading').forEach(el => {
        el.innerHTML = errorDiv;
      });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', loadDashboard);

    // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
    setInterval(loadDashboard, 30000);

    console.log('ğŸ“Š ë°©ë¬¸ì ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì™„ë£Œ');
  </script>
</body>

</html>