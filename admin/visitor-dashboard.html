<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë°©ë¬¸ì í†µê³„ ëŒ€ì‹œë³´ë“œ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .dashboard-header {
      text-align: center;
      margin-bottom: 40px;
      color: #333;
    }

    .dashboard-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .stat-card h3 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .stat-card .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-card .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .data-section {
      margin-bottom: 30px;
    }

    .data-section h2 {
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .data-table th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }

    .data-table tr:hover {
      background-color: #f8f9ff;
    }

    .refresh-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1rem;
      margin-bottom: 20px;
      transition: transform 0.2s;
    }

    .refresh-btn:hover {
      transform: translateY(-2px);
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #667eea;
    }

    .error {
      color: #e74c3c;
      background: #ffeaea;
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
    }

    @media (max-width: 768px) {
      .dashboard-container {
        padding: 20px;
      }

      .dashboard-header h1 {
        font-size: 2rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .data-table {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <h1>ğŸŒ ë°©ë¬¸ì í†µê³„ ëŒ€ì‹œë³´ë“œ</h1>
      <p>ì‹¤ì‹œê°„ ì›¹ì‚¬ì´íŠ¸ ë°©ë¬¸ì ë¶„ì„</p>
    </div>

    <button class="refresh-btn" onclick="loadDashboard()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>ì‹¤ì‹œê°„ ë°©ë¬¸ì</h3>
        <div class="stat-number" id="liveVisitors">-</div>
        <div class="stat-label">í˜„ì¬ ì˜¨ë¼ì¸</div>
      </div>

      <div class="stat-card">
        <h3>ì˜¤ëŠ˜ ë°©ë¬¸ì</h3>
        <div class="stat-number" id="todayVisitors">-</div>
        <div class="stat-label">ê³ ìœ  ë°©ë¬¸ì</div>
      </div>

      <div class="stat-card">
        <h3>ì˜¤ëŠ˜ í˜ì´ì§€ë·°</h3>
        <div class="stat-number" id="todayPageViews">-</div>
        <div class="stat-label">ì´ ë°©ë¬¸ ìˆ˜</div>
      </div>

      <div class="stat-card">
        <h3>ì „ì²´ IP ìˆ˜</h3>
        <div class="stat-number" id="totalIPs">-</div>
        <div class="stat-label">ëˆ„ì  ê³ ìœ  IP</div>
      </div>
    </div>

    <div class="data-section">
      <h2>ğŸ“Š ìƒìœ„ ë°©ë¬¸ IP</h2>
      <div id="topIPsTable" class="loading">ë¡œë”© ì¤‘...</div>
    </div>

    <div class="data-section">
      <h2>ğŸ“… ì¼ë³„ ë°©ë¬¸ í†µê³„</h2>
      <div id="dailyStatsTable" class="loading">ë¡œë”© ì¤‘...</div>
    </div>

    <div class="data-section">
      <h2>ğŸŒ ìµœê·¼ ë°©ë¬¸ì</h2>
      <div id="recentVisitorsTable" class="loading">ë¡œë”© ì¤‘...</div>
    </div>
  </div>

  <script type="module">
    import { supabase } from '../scripts/api.js';

    // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
    async function loadDashboard() {
      try {
        // ë³‘ë ¬ë¡œ ëª¨ë“  ë°ì´í„° ë¡œë“œ
        const [
          liveCount,
          todayStats,
          topIPs,
          dailyStats,
          recentVisitors
        ] = await Promise.all([
          getLiveVisitorCount(),
          getTodayStats(),
          getTopIPs(),
          getDailyStats(),
          getRecentVisitors()
        ]);

        // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
        document.getElementById('liveVisitors').textContent = liveCount;
        document.getElementById('todayVisitors').textContent = todayStats.unique_visitors;
        document.getElementById('todayPageViews').textContent = todayStats.total_visits;
        document.getElementById('totalIPs').textContent = topIPs.length;

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        renderTopIPsTable(topIPs);
        renderDailyStatsTable(dailyStats);
        renderRecentVisitorsTable(recentVisitors);

      } catch (error) {
        console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
        showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    // ì‹¤ì‹œê°„ ë°©ë¬¸ì ìˆ˜ ì¡°íšŒ (ê°„ë‹¨í•œ ë°©ë²•)
    async function getLiveVisitorCount() {
      try {
        const { data, error } = await supabase.rpc('get_live_visitor_count');
        if (error) {
          console.error('ì‹¤ì‹œê°„ ë°©ë¬¸ì ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
          // ëŒ€ì²´ ë°©ë²•: ì§ì ‘ ì¿¼ë¦¬
          const { data: fallbackData, error: fallbackError } = await supabase
            .from('visitor_logs')
            .select('session_id')
            .gte('created_at', new Date(Date.now() - 30 * 60 * 1000).toISOString());

          if (fallbackError) throw fallbackError;

          const uniqueSessions = new Set(fallbackData.map(row => row.session_id));
          return uniqueSessions.size;
        }
        return data || 0;
      } catch (error) {
        console.error('ì‹¤ì‹œê°„ ë°©ë¬¸ì ìˆ˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
        return 0;
      }
    }    // ì˜¤ëŠ˜ í†µê³„ ì¡°íšŒ
    async function getTodayStats() {
      const today = new Date().toISOString().split('T')[0];
      const { data, error } = await supabase
        .from('daily_visitor_stats')
        .select('*')
        .eq('visit_date', today)
        .single();

      if (error && error.code !== 'PGRST116') throw error;
      return data || { unique_visitors: 0, total_visits: 0 };
    }

    // ìƒìœ„ IP ì¡°íšŒ (ê°„ë‹¨í•œ ë°©ë²•)
    async function getTopIPs() {
      try {
        const { data, error } = await supabase.rpc('get_ip_visit_stats', { p_limit: 10 });
        if (error) {
          console.error('ìƒìœ„ IP ì¡°íšŒ ì‹¤íŒ¨:', error);
          // ëŒ€ì²´ ë°©ë²•: ì§ì ‘ ì¿¼ë¦¬
          const { data: fallbackData, error: fallbackError } = await supabase
            .from('visitor_logs')
            .select('ip_address, created_at')
            .not('ip_address', 'is', null)
            .order('created_at', { ascending: false })
            .limit(100);

          if (fallbackError) throw fallbackError;

          // JavaScriptì—ì„œ ê·¸ë£¹í•‘
          const ipCounts = {};
          fallbackData.forEach(row => {
            const ip = row.ip_address;
            if (!ipCounts[ip]) {
              ipCounts[ip] = {
                ip_address: ip,
                visit_count: 0,
                first_visit: row.created_at,
                last_visit: row.created_at
              };
            }
            ipCounts[ip].visit_count++;
            if (row.created_at > ipCounts[ip].last_visit) {
              ipCounts[ip].last_visit = row.created_at;
            }
            if (row.created_at < ipCounts[ip].first_visit) {
              ipCounts[ip].first_visit = row.created_at;
            }
          });

          return Object.values(ipCounts)
            .sort((a, b) => b.visit_count - a.visit_count)
            .slice(0, 10);
        }
        return data || [];
      } catch (error) {
        console.error('ìƒìœ„ IP ì¡°íšŒ ì˜¤ë¥˜:', error);
        return [];
      }
    }    // ì¼ë³„ í†µê³„ ì¡°íšŒ
    async function getDailyStats() {
      const { data, error } = await supabase
        .from('daily_visitor_stats')
        .select('*')
        .order('visit_date', { ascending: false })
        .limit(7);

      if (error) throw error;
      return data || [];
    }

    // ìµœê·¼ ë°©ë¬¸ì ì¡°íšŒ
    async function getRecentVisitors() {
      const { data, error } = await supabase
        .from('visitor_logs')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(20);

      if (error) throw error;
      return data || [];
    }

    // ìƒìœ„ IP í…Œì´ë¸” ë Œë”ë§
    function renderTopIPsTable(data) {
      const container = document.getElementById('topIPsTable');

      if (!data.length) {
        container.innerHTML = '<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>IP ì£¼ì†Œ</th>
                            <th>ë°©ë¬¸ íšŸìˆ˜</th>
                            <th>ìµœê·¼ ë°©ë¬¸</th>
                            <th>ìµœì´ˆ ë°©ë¬¸</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(row => `
                            <tr>
                                <td>${row.ip_address}</td>
                                <td>${row.visit_count}</td>
                                <td>${new Date(row.last_visit).toLocaleString('ko-KR')}</td>
                                <td>${new Date(row.first_visit).toLocaleString('ko-KR')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

      container.innerHTML = table;
    }

    // ì¼ë³„ í†µê³„ í…Œì´ë¸” ë Œë”ë§
    function renderDailyStatsTable(data) {
      const container = document.getElementById('dailyStatsTable');

      if (!data.length) {
        container.innerHTML = '<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ê³ ìœ  ë°©ë¬¸ì</th>
                            <th>ì´ ë°©ë¬¸ ìˆ˜</th>
                            <th>ë¡œê·¸ì¸ ì‚¬ìš©ì</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(row => `
                            <tr>
                                <td>${row.visit_date}</td>
                                <td>${row.unique_visitors}</td>
                                <td>${row.total_visits}</td>
                                <td>${row.authenticated_users}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

      container.innerHTML = table;
    }

    // ìµœê·¼ ë°©ë¬¸ì í…Œì´ë¸” ë Œë”ë§
    function renderRecentVisitorsTable(data) {
      const container = document.getElementById('recentVisitorsTable');

      if (!data.length) {
        container.innerHTML = '<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>IP ì£¼ì†Œ</th>
                            <th>ë””ë°”ì´ìŠ¤</th>
                            <th>ë¸Œë¼ìš°ì €</th>
                            <th>OS</th>
                            <th>ë°©ë¬¸ ì‹œê°„</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(row => `
                            <tr>
                                <td>${row.ip_address}</td>
                                <td>${row.device_type || '-'}</td>
                                <td>${row.browser || '-'}</td>
                                <td>${row.os || '-'}</td>
                                <td>${new Date(row.created_at).toLocaleString('ko-KR')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

      container.innerHTML = table;
    }

    // ì—ëŸ¬ í‘œì‹œ
    function showError(message) {
      const errorDiv = `<div class="error">âŒ ${message}</div>`;
      document.querySelectorAll('.loading').forEach(el => {
        el.innerHTML = errorDiv;
      });
    }

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
    window.loadDashboard = loadDashboard;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', loadDashboard);

    // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
    setInterval(loadDashboard, 30000);
  </script>
</body>

</html>