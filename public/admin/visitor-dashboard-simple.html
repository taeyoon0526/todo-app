<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>방문자 통계 대시보드</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .dashboard {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5rem;
      color: #333;
      margin-bottom: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .stat-card h3 {
      font-size: 1.2rem;
      margin-bottom: 15px;
      opacity: 0.9;
    }

    .stat-number {
      font-size: 3rem;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .data-section {
      margin-bottom: 30px;
    }

    .data-section h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .data-table th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }

    .data-table tr:hover {
      background-color: #f8f9ff;
    }

    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }

    .refresh-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .refresh-btn:hover {
      opacity: 0.9;
    }

    .last-updated {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div class="dashboard">
    <div class="header">
      <h1>🔍 방문자 통계 대시보드</h1>
      <button class="refresh-btn" onclick="loadDashboard()">📊 새로고침</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>실시간 방문자</h3>
        <div class="stat-number" id="liveVisitors">-</div>
        <div>현재 접속 중</div>
      </div>
      <div class="stat-card">
        <h3>오늘 방문자</h3>
        <div class="stat-number" id="todayVisitors">-</div>
        <div>고유 방문자</div>
      </div>
      <div class="stat-card">
        <h3>오늘 총 방문</h3>
        <div class="stat-number" id="todayVisits">-</div>
        <div>페이지 뷰</div>
      </div>
      <div class="stat-card">
        <h3>총 방문자</h3>
        <div class="stat-number" id="totalVisitors">-</div>
        <div>누적 방문자</div>
      </div>
    </div>

    <div class="data-section">
      <h2>📋 최근 방문자</h2>
      <div id="recentVisitors" class="loading">데이터를 불러오는 중...</div>
    </div>

    <div class="data-section">
      <h2>🌐 상위 IP 주소</h2>
      <div id="topIPs" class="loading">데이터를 불러오는 중...</div>
    </div>

    <div class="last-updated" id="lastUpdated">
      마지막 업데이트: -
    </div>
  </div>

  <script src="../scripts/api.js"></script>
  <script>
    // 대시보드 데이터 로드
    async function loadDashboard() {
      console.log('📊 대시보드 데이터 로드 시작...');

      try {
        // 실시간 방문자 수
        await loadLiveVisitors();

        // 오늘 통계
        await loadTodayStats();

        // 총 방문자 수
        await loadTotalStats();

        // 최근 방문자
        await loadRecentVisitors();

        // 상위 IP
        await loadTopIPs();

        // 마지막 업데이트 시간
        document.getElementById('lastUpdated').textContent =
          `마지막 업데이트: ${new Date().toLocaleString('ko-KR')}`;

        console.log('✅ 대시보드 로드 완료');

      } catch (error) {
        console.error('❌ 대시보드 로드 실패:', error);
        showError('대시보드를 불러오는데 실패했습니다: ' + error.message);
      }
    }

    // 실시간 방문자 수 (최근 5분)
    async function loadLiveVisitors() {
      try {
        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
        const { data, error } = await supabase
          .from('visitor_logs')
          .select('session_id')
          .gte('created_at', fiveMinutesAgo)
          .not('session_id', 'is', null);

        if (error) throw error;

        const uniqueSessions = new Set(data.map(row => row.session_id));
        document.getElementById('liveVisitors').textContent = uniqueSessions.size;

      } catch (error) {
        console.error('실시간 방문자 로드 실패:', error);
        document.getElementById('liveVisitors').textContent = '0';
      }
    }

    // 오늘 통계
    async function loadTodayStats() {
      try {
        const today = new Date().toISOString().split('T')[0];
        const { data, error } = await supabase
          .from('visitor_logs')
          .select('session_id')
          .gte('created_at', today + 'T00:00:00.000Z')
          .lt('created_at', today + 'T23:59:59.999Z');

        if (error) throw error;

        const uniqueVisitors = new Set(data.map(row => row.session_id)).size;
        const totalVisits = data.length;

        document.getElementById('todayVisitors').textContent = uniqueVisitors;
        document.getElementById('todayVisits').textContent = totalVisits;

      } catch (error) {
        console.error('오늘 통계 로드 실패:', error);
        document.getElementById('todayVisitors').textContent = '0';
        document.getElementById('todayVisits').textContent = '0';
      }
    }

    // 총 방문자 수
    async function loadTotalStats() {
      try {
        const { data, error } = await supabase
          .from('visitor_logs')
          .select('session_id')
          .not('session_id', 'is', null);

        if (error) throw error;

        const totalUniqueVisitors = new Set(data.map(row => row.session_id)).size;
        document.getElementById('totalVisitors').textContent = totalUniqueVisitors;

      } catch (error) {
        console.error('총 통계 로드 실패:', error);
        document.getElementById('totalVisitors').textContent = '0';
      }
    }

    // 최근 방문자
    async function loadRecentVisitors() {
      try {
        const { data, error } = await supabase
          .from('visitor_logs')
          .select('ip_address, device_type, browser, os, created_at, url')
          .order('created_at', { ascending: false })
          .limit(10);

        if (error) throw error;

        let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>IP 주소</th>
                                <th>디바이스</th>
                                <th>브라우저</th>
                                <th>OS</th>
                                <th>방문 시간</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

        data.forEach(row => {
          html += `
                        <tr>
                            <td>${row.ip_address || 'Unknown'}</td>
                            <td>${row.device_type || '-'}</td>
                            <td>${row.browser || '-'}</td>
                            <td>${row.os || '-'}</td>
                            <td>${new Date(row.created_at).toLocaleString('ko-KR')}</td>
                        </tr>
                    `;
        });

        html += '</tbody></table>';
        document.getElementById('recentVisitors').innerHTML = html;

      } catch (error) {
        console.error('최근 방문자 로드 실패:', error);
        document.getElementById('recentVisitors').innerHTML =
          '<div class="error">최근 방문자 데이터를 불러올 수 없습니다</div>';
      }
    }

    // 상위 IP 주소
    async function loadTopIPs() {
      try {
        const { data, error } = await supabase
          .from('visitor_logs')
          .select('ip_address, created_at, session_id')
          .not('ip_address', 'is', null)
          .order('created_at', { ascending: false })
          .limit(500); // 최근 500개만 분석

        if (error) throw error;

        // JavaScript로 IP별 통계 계산
        const ipStats = {};
        data.forEach(row => {
          const ip = row.ip_address;
          if (!ipStats[ip]) {
            ipStats[ip] = {
              ip: ip,
              visits: 0,
              lastVisit: row.created_at,
              sessions: new Set()
            };
          }
          ipStats[ip].visits++;
          ipStats[ip].sessions.add(row.session_id);
          if (new Date(row.created_at) > new Date(ipStats[ip].lastVisit)) {
            ipStats[ip].lastVisit = row.created_at;
          }
        });

        // 상위 10개 정렬
        const topIPs = Object.values(ipStats)
          .map(stat => ({
            ...stat,
            uniqueSessions: stat.sessions.size
          }))
          .sort((a, b) => b.visits - a.visits)
          .slice(0, 10);

        let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>IP 주소</th>
                                <th>방문 횟수</th>
                                <th>고유 세션</th>
                                <th>마지막 방문</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

        topIPs.forEach(ip => {
          html += `
                        <tr>
                            <td>${ip.ip}</td>
                            <td>${ip.visits}</td>
                            <td>${ip.uniqueSessions}</td>
                            <td>${new Date(ip.lastVisit).toLocaleString('ko-KR')}</td>
                        </tr>
                    `;
        });

        html += '</tbody></table>';
        document.getElementById('topIPs').innerHTML = html;

      } catch (error) {
        console.error('상위 IP 로드 실패:', error);
        document.getElementById('topIPs').innerHTML =
          '<div class="error">상위 IP 데이터를 불러올 수 없습니다</div>';
      }
    }

    // 에러 표시
    function showError(message) {
      const errorDiv = `<div class="error">❌ ${message}</div>`;
      document.querySelectorAll('.loading').forEach(el => {
        el.innerHTML = errorDiv;
      });
    }

    // 페이지 로드 시 실행
    document.addEventListener('DOMContentLoaded', loadDashboard);

    // 30초마다 자동 새로고침
    setInterval(loadDashboard, 30000);

    console.log('📊 방문자 대시보드 초기화 완료');
  </script>
</body>

</html>